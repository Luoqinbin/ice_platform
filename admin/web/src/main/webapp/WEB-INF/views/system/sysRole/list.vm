<!DOCTYPE html>
<html lang="zh_cn">
<head>
    <base href="../">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>角色列表</title>
    <!-- Bootstrap Core CSS -->
    <link href="static/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="static/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css"
          rel="stylesheet">
    <!-- DataTables Responsive CSS -->
    <link href="static/bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="static/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="static/zTree/css/demo.css" type="text/css">
    <link rel="stylesheet" href="static/zTree/css/zTreeStyle/zTreeStyle.css" type="text/css">
</head>

<body>

<div id="wrapper">
    <div id="page-wrapper" style="padding: 5px">
        <div class="well">
            <div class="row">
                <form class="form-horizontal" role="form">
                    <div class="col-lg-1">
                        <div class="input-group">
                            <input class="form-control" placeholder="角色名称" name="roleName" id="roleName" autofocus>
                        </div>
                    </div>
                    <button type="button" id="queryBtn" class="btn btn-primary"><i class="glyphicon glyphicon-search"></i>查询
                    </button>
                    <button type="button" id="addBtn" class="btn btn-info"><i class="glyphicon glyphicon-plus"></i>新增
                    </button>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <b>系统角色</b>
                    </div>
                    <div class="panel-body">
                        <div class="dataTable_wrapper">
                            <table width="100%" class="table table-striped table-bordered table-hover"
                                   id="dataTables-example">
                                <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>角色名称</th>
                                    <th>角色描述</th>
                                    <th>角色代码</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--添加-->
<div id="addWin" style="display: none">
    <div class="row" style="margin: 10px">
        <div class="login-panel panel panel-default">
            <div class="panel-body">
                <form role="form" action="sysRole/add" method="post" id="addForm" onsubmit="return submitCheck()">
                    <fieldset>
                        <input type="hidden" value="${_csrf.token}" name="${_csrf.parameterName}">
                        <div>
                            <label>角色名称*：</label>
                            <div class="form-group">
                                <input type="text" class="form-control" name="role_name" placeholder="请输入角色名称" required>
                            </div>
                        </div>
                        <div>
                            <label>角色代码*：</label>
                            <div class="form-group">
                                <input type="text" class="form-control" name="role_auth" placeholder="请输入角色代码" required>
                            </div>
                        </div>
                        <div>
                            <label>角色描述：</label>
                            <div class="form-group">
                                <input type="text" class="form-control" name="role_desc" placeholder="">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 修改 -->
<div id="updateWin" style="display: none">
    <div class="row" style="margin: 10px">
        <div class="login-panel panel panel-default">
            <div class="panel-body">
                <form role="form" action="sysRole/update" method="post" id="updateForm" parsley-validate>
                    <fieldset>
                        <div>
                            <label>角色名称*：</label>
                            <input type="hidden" value="${_csrf.token}" name="${_csrf.parameterName}">
                            <input type="hidden" value="" name="id" id="idUpdate">
                            <div class="form-group">
                                <input type="text" class="form-control" id="roleNameUpdate" name="role_name"
                                       placeholder="角色名称" required>
                            </div>
                        </div>
                        <div>
                            <label>角色代码*：</label>
                            <div class="form-group">
                                <input type="text" class="form-control" id="roleAuthUpdate" name="role_auth" required>
                            </div>
                        </div>
                        <div>
                            <label>角色描述：</label>
                            <div class="form-group">
                                <input type="text" class="form-control" id="roleDescUpdate" name="role_desc">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- zTree -->
<div class="content_wrap" id="treeWin" style="display: none">
    <div class="zTreeDemoBackground left" style="margin-left: 17px;">
        <ul id="treeDemo" class="ztree"></ul>
    </div>
    <div id="buttonDiv" class="right" style="margin-left: -50px;display: none">
        <ul class="info">
            <li class="title"><h2 id="buttonTitle"></h2>
                <input type="hidden" id="roleId"/>
                <input type="hidden" id="resourceId"/>
                <div id="showBtnDiv">
                    <!--
                    <label><input name="resourceBtn" type="checkbox" value="" />苹果 </label><br/>
                    <label><input name="resourceBtn" type="checkbox" value="" />桃子 </label><br/>
                    <label><input name="resourceBtn" type="checkbox" value="" />香蕉 </label><br/>
                    <label><input name="resourceBtn" type="checkbox" value="" />梨 </label><br/>
                     -->
                </div>
            </li>
        </ul>
    </div>
</div>
<!-- jQuery -->
<script src="static/bower_components/jquery/dist/jquery.min.js"></script>
<script src="static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="static/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="static/bower_components/datatables-plugins/api/fnReloadAjax.js"></script>
<script src="static/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
<script src="static/bower_components/datatables-responsive/js/dataTables.responsive.js"></script>
<script src="static/js/common.js"></script>
<script src="static/layer/layer.js"></script>
<script src="static/js/jquery.form.js"></script>
<script src="static/parsley/i18n/messages.zh_cn.js"></script>
<script src="static/parsley/parsley.min.js"></script>
<script src="static/zTree/js/jquery.ztree.core.js"></script>
<script src="static/zTree/js/jquery.ztree.excheck.js"></script>
<script>
    //****************************zTree**********************************
    var setting = {
        check: {
            enable: true
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pId",
                rootPId: null
            }
        },
        callback: {
            onClick: showButtonResource
        }
    };

    function showButtonResource(event, treeId, treeNode) {
        $("#buttonDiv").show();
        $("#buttonTitle").html(treeNode.name);
        $("#resourceId").val(treeNode.id);
        //加载按钮资源
        $.post("sysRole/getResourceBtn", {
            "${_csrf.parameterName}": "${_csrf.token}",
            "partentId": treeNode.id,
            "roleId": $("#roleId").val()
        }, function (data) {
            if (data.code == 200) {
                $('#showBtnDiv').empty();
                var btnList = data.data;
                if (btnList.length > 0) {
                    var html = "";
                    for (var i = 0; i < btnList.length; i++) {
                        if (btnList[i].isCheck == 1) {
                            html += "<div class=\"checkbox\"><label><input name=\"resourceBtn\" checked=\"checked\" type=\"checkbox\" value=\"" + btnList[i].id + "\"/>" + btnList[i].name + "</label><br/></div>";
                        } else {
                            html += "<div class=\"checkbox\"><label><input name=\"resourceBtn\" type=\"checkbox\" value=\"" + btnList[i].id + "\"/>" + btnList[i].name + "</label><br/></div>";
                        }
                    }
                    $('#showBtnDiv').append(html);
                } else {
                    $('#showBtnDiv').append("<label>无数据</label>");
                }
            }
        }, "json");
    }
    ;
    //显示树形菜单
    function showTree(id) {
        $('#showBtnDiv').empty();
        $("#roleId").val(id);
        //加载资源
        $.ajax({
            type: "POST",
            dataType: "json",
            async: false,
            url: "sysRole/getResource",
            data: {"${_csrf.parameterName}": "${_csrf.token}", "roleId": id},
            success: function (data) {
                if (data.code == 200) {
                    zNodes = data.data;
                }
            }
        });
        //加载菜单
        $.fn.zTree.init($("#treeDemo"), setting, zNodes);
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.expandAll(true);
        var betBot = layer.open({
            area: ['600px', '500px'],
            title: "角色权限",
            type: 1,
            content: $("#treeWin"),
            btn: ['保存', '关闭'],

            yes: function (layero, index) {
                //保存触发
                //1.获取菜单资源
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                var nodes = treeObj.getCheckedNodes(true);
                var resourceValue = new Array();
                for (var i = 0; i < nodes.length; i++) {
                    resourceValue.push(nodes[i].id);
                }
                //2.获取按钮资源
                var btnValue = new Array();//定义一个数组
                $('input[name="resourceBtn"]:checked').each(function () {//遍历每一个名字为interest的复选框，其中选中的执行函数
                    btnValue.push($(this).val());//将选中的值添加到数组chk_value中
                });
                //保存
                $.ajax({
                    type: 'post',
                    traditional: true,
                    url: 'sysRole/saveResource',
                    data: {
                        "${_csrf.parameterName}": "${_csrf.token}",
                        "roleId": id,
                        "resourceValue": resourceValue,
                        "resourceId": $("#resourceId").val(),
                        "btnValue": btnValue
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            layer.msg('保存成功');
                        }
                    }
                });
            },
            cancel: function (index, layero) {
                //关闭触发
                layer.close(index);
            }
        });
    }
    //****************************zTree**********************************
    var aoColumns = [
        {"mData": ""},
        {"mData": "role_name"},
        {"mData": "role_desc"},
        {"mData": "role_auth"},
        {"mData": null}
    ];

    var aoColumnDefs = [{
        "aTargets": [4],
        "mRender": function (a, b, c, d) {
            return "<button type=\"button\" class=\"btn-link\" onclick=\"edit('"+ c.id+"')\">修改</button><button type=\"button\" class=\"btn-link\" onclick=\"del('" + c.id + "')\">删除</button><button type=\"button\" class=\"btn-link\" onclick=\"showTree('" + c.id + "')\">设置权限</button>";
        }
    }];
    var tab;
    $(document).ready(function () {

        var data = "${_csrf.parameterName}=${_csrf.token}";
        tab = tableContent1("dataTables-example", "sysRole/queryList", aoColumns, aoColumnDefs, data);

        $("#queryBtn").bind("click", function () {
            var roleName = $("#roleName");
            var data = "${_csrf.parameterName}=${_csrf.token}&role_name=" + roleName.val();
            tab.fnReloadAjax("sysRole/queryList?"+data);
        });
        //添加
        var addBtn = $('#addBtn');
        addBtn.click(function () {
            var betBot = layer.open({
                area: ['500px', '400px'],
                title: "新增角色",
                type: 1,
                content: $("#addWin"),
                btn: ['添加', '关闭'],
                success: function (layero, index) {
                    $("#addForm").resetForm();
                    $("#addForm").parsley().reset();
                },
                yes: function (layero, index) {
                    if ($('#addForm').parsley().validate()) {
                        $("#addForm").ajaxSubmit({
                            success: function (d) {
                                if (d.code == 200) {

                                    layer.msg("添加数据成功");
                                    layer.closeAll();
                                    tab.fnReloadAjax();
                                } else {
                                    layer.msg(d.message);
                                }
                            }
                        })
                    }
                },
                cancel: function (index, layero) {
                    layer.close(index);
                }
            });
        });
    });
    //修改
    function edit(id) {
        $.post("sysRole/getById", {"${_csrf.parameterName}": "${_csrf.token}", "id": id}, function (data) {
            $("#updateForm").parsley().reset();
            if (data.code == 200) {
                var d = data.data;
                $("#idUpdate").val(d.id);
                $("#roleNameUpdate").val(d.role_name);
                $("#roleDescUpdate").val(d.role_desc);
                $("#roleAuthUpdate").val(d.role_auth);
                layer.open({
                    area: ['500px', '410px'],
                    title: "修改",
                    type: 1,
                    content: $("#updateWin"),
                    btn: ['确定', '关闭'],
                    yes: function (layero, index) {
                        if ($('#updateForm').parsley().validate()) {
                            $("#updateForm").ajaxSubmit({
                                success: function (d) {
                                    if (d.code == 200) {
                                        tab.fnReloadAjax();
                                        layer.closeAll();
                                    } else {
                                        layer.msg(d.message);
                                    }
                                }
                            })
                        }
                    },
                    cancel: function (index, layero) {
                        layer.close(index);
                    }
                });
            } else {
                layer.msg("更新数据失败");
            }

        }, "json");
    }
    function del(id) {
        layer.confirm("你确定要删除该数据吗？", function (index) {
            $.post("sysRole/delete", {"${_csrf.parameterName}": "${_csrf.token}", "id": id}, function (data) {
                if (data.code == 200) {
                    layer.msg("删除成功");
                    layer.close(index);
                    var data = "${_csrf.parameterName}=${_csrf.token}";
                    tab.fnReloadAjax("sysRole/queryList?" + data);
                }
            }, "json");

        });
    }
</script>

</body>

</html>
